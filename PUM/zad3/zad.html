<!-- 
	1. Proszę przygotować prostą grę, w której (u dołu ekranu) sterujemy(prawo-lewo) prostokątem. 
	   Po naciśnięciu spacji strzelamy małymi kulkami, które niszczą (znikają) duże kółka pojawiające się u góry ekranu.
	2. Jeśli uda się Państwu zrealizować punkt 1 to proszę dodać "licznik"/"punktację". 
	   Gdzieś na stronie ma znajdować liczba "zestrzelonych" kulek. -->

<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
	</head>
	<body>
		<canvas width="800" height="600" style="border: 1px solid green;"></canvas>
		<script>
			var canvas = document.querySelector('canvas');
			var c = canvas.getContext('2d');

			var cw = canvas.width;
			var ch = canvas.height;
			var r = 50;
			var color = 0;
			var keys = [];

			var rectw = 20;
			var recth = 40;			
			var rectx = (cw - rectw ) / 2;
			var recty = ch - recth;

			var bulletx = -1;
			var bullety = -1;
			var bulletr = 5;
			var bulletspeed = 450;

			var targetR = 20;
			var maxTargets = Math.floor((cw / (targetR * 2 + 10)));
			var targets = [];
			var targetSpawnDelay = 0.5;
			var targetSpawnCount = 0;
			
			var starttime = null;
			
			function spawnTarget() {
				var x = 0;//Math.floor(Math.random() * (cw / (targetR * 2 + 10)));
				var found = false;
				while (!found) {
					found = true;
					x = Math.floor(Math.random() * maxTargets);//(cw / (targetR * 2 + 10))) * (targetR * 2 + 10);
					for (let target of targets) {
						if (target == x) {
							found = false;
							break;
						}
					}
				}

				targets.push(x);
			}

			function frame(timestamp) {
				
				if (!starttime) starttime = timestamp;

				var frameInc = (timestamp - starttime) / 1000;
				starttime = timestamp;

				if (targets.length < maxTargets) {
					if (targetSpawnCount < targetSpawnDelay) {
						targetSpawnCount += frameInc;
					} else {
						spawnTarget();
						targetSpawnCount = 0;
					}
				}

				handleKeys(frameInc);
				c.clearRect(0, 0, cw, ch);

				c.beginPath();
				c.rect(rectx, recty, rectw, recth);
				c.fillStyle = 'red';
				c.fill();

				for (let target of targets) {
					var x = target * (targetR * 2 + 10) + targetR;
					c.beginPath();
					c.arc(x, targetR, targetR, 0, 2*Math.PI, false);
					c.fillStyle = 'blue';
					c.fill();
				}

				if (bulletx != -1) {
					c.beginPath();
					c.arc(bulletx, bullety, bulletr, 0, 2*Math.PI, false);
					c.fillStyle = 'green';
					c.fill();
					if (bullety + bulletr < 0) {
						bulletx = -1;
						bullety = -1;
					}

					// Checking collision
					if (bullety + bulletr <= targetR * 2) {
						var i = 0;
						for (let target of targets) {
							var x = target * (targetR * 2 + 10) + targetR;
							if (bulletx + bulletr >= x - targetR && bulletx - bulletr <= x + targetR) {
								targets.splice(i, 1);
								bulletx = -1;
								bullety = -1;
								break;
							}
							i++;
						}
					}

					bullety -= bulletspeed * frameInc;
				}

				// if (color == 0) {
				// 	c.fillStyle = 'blue';
				// 	color = 1;
				// } else {
				// 	c.fillStyle = 'green';
				// 	color = 0;
				// }

				// c.clearRect(0, 0, cw, ch);
				// c.beginPath();
				// c.arc((cw) / 2, (ch) / 2, r, 0, 2*Math.PI, false);
				// c.fill();
				setTimeout(requestAnimationFrame, 10, frame);
			}

			frame();

			function handleKeys(dt) {
				//d - 68
				//> - 39

				//a - 65
				//< - 37
				const speed = 500 * dt;
				if ((keys[68] || keys[39])) { // prawo
					rectx += speed;
				}

				if ((keys[65] || keys[37])) { // lewo
					rectx -= speed;
				}
				
				if (keys[32] && bulletx == -1) {
					// Shoot
					bulletx = rectx + rectw / 2;
					bullety = recty - bulletr;
				}
			}



			document.body.addEventListener('keyup', keyUp);
			document.body.addEventListener('keydown', keyDown);

			function keyUp(e) {
				keys[e.keyCode] = false;
			}

			function keyDown(e) {
				keys[e.keyCode] = true;
			}
		</script>
	</body>
</html>