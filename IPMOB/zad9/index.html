<html>
	<head>
		<style>
			input:invalid {
				border-color: red;
			}
			input:required:valid {
				border-color: green;
			}

			form > div >* {
				margin-bottom: 5px;
				padding: 5px;
			}
			.removable_field {
				/* margin-bottom: 5px; */
			}

			#saved_users > ul > li > span:active {
				text-decoration: none;
				background: rgb(100, 57, 52);
			}

			#saved_users > ul > li > span:hover {
				text-decoration: underline;
				cursor: pointer;
				background: lightsalmon;
			}

			#saved_users > ul > li > span{
				/* margin: 0px; */
				padding: 5px;
			}

			#saved_users > ul > li {
				margin: 5px;
			}
		</style>
		<script src="../genData.js" type="text/javascript"></script>
	</head>
	<body>
		<form>
			<div class="removable_field">	
				Email: 
				<input type="email" name="email"placeholder="user@site.com" required>
				<button onclick="removethis(event)">X</button>
				<br>
			</div>
			<div class="removable_field">
				Kod pocztowy: 
				<input type="text" name="postal" pattern="\d\d-\d\d\d" title="2 cyfry myślnik i 3 cyfry" placeholder="12-345" required> 
				<button onclick="removethis(event)">X</button>
				<br>
			</div>
			<div class="removable_field">
				Numer nip: 
				<input type="text" name="nip" pattern="\d{3}-\d{3}-\d{2}-\d{2}" placeholder="123-456-32-18" required> 
				<button onclick="removethis(event)">X</button>
				<br>
			</div>
			<div class="removable_field">
				Numer dowodu: 
				<input type="text" name="dowod" pattern="[A-Z]{3}\d{6}" placeholder="ABA300000" required> 
				<button onclick="removethis(event)">X</button>
				<br>
			</div>
			<div class="removable_field">
				Adres ipv4: 
				<input type="text" name="ip" pattern="\b((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\.|$)){4}\b" placeholder="192.168.1.1" required> 
				<button onclick="removethis(event)">X</button>
				<br>
			</div>
			<div class="removable_field">
				Strona www:
				<input type="text" name="www" pattern="(https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9]+\.[^\s]{2,}|www\.[a-zA-Z0-9]+\.[^\s]{2,})" placeholder="www.example.com" required> 
				<button onclick="removethis(event)">X</button>
				<br>
			</div>
			<div class="removable_field">
				Ścieżka dysku: 
				<input type="text" name="windirbig" pattern="[a-zA-Z]:(\\(windows|windows|winnt|win|dos|msdos))\\.+" placeholder="c:\WinDows\user" required> 
				<button onclick="removethis(event)">X</button>
				<br>
			</div>
			<div class="removable_field">
				Ścieżka dysku: 
				<input type="text" name="windir" pattern="[a-zA-Z]:(\\([Ww]indows|[Ww]innt|[Ww]in|[Dd]os|[Mm]sdos))\\.+" placeholder="c:\windows\user" required> 
				<button onclick="removethis(event)">X</button>
				<br>
			</div>
			<div class="removable_field">
				Ścieżka do pliku w katalogu /etc: 
				<input type="text" name="etcdir" pattern="\/etc(\/[a-zA-Z]+)+" placeholder="/etc/passwd" required> 
				<button onclick="removethis(event)">X</button>
				<br>
			</div>
			<div class="removable_field" ondragover="dragover(event)">
				Adres ipv6:
				<input type="text" name="ipv6addr" pattern="(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))" placeholder="::ffff:c000:0280" required> 
				<button onclick="removethis(event)">X</button>
				<br>
			</div>
			<div class="removable_field" draggable="true" id="phonenb" ondragstart="dragstart(event)">
				Numer telefonu:
				<input type="text" name="phonenb" pattern="(\d{9}|((\d{3}(\s|-|\/){0,1}){3}))" placeholder="123 456 789" required> 
				<button onclick="removethis(event)">X</button>
				<br>
			</div>
		</form>
		<button onclick="savedata()">save</button>
		<button onclick="genData()">Generate data</button>
		<!-- <button onclick="loaddata()">load</button> -->
		<div id="saved_users"></div>
		<script>
			var db;
			window.onload = () => {
				//Open Database
				
				if (!('indexedDB' in window)) {
					console.log("no indexeddb");
					return;
				}
				var idb = window.indexedDB;
				var request = idb.open('test-db1', 3);

				request.onerror = event => {
					console.log("Error happened: ", event);
				}

				request.onsuccess = event => {
					db = event.target.result;
					console.log("success");
					var transaction = db.transaction(['name']);
					var objectStore = transaction.objectStore('name');
					var request = objectStore.getAll();
					request.onerror = event => {
						out.innerHTML = "error when getting data " + event.toString();
					}

					request.onsuccess = event => {
						reloadList();
						// console.log("Result: ");
						// var div = document.getElementById("saved_users");
						// var ul = document.createElement("ul");
						// for (var r of request.result) {
						// 	var li = document.createElement("li");
						// 	li.innerHTML = `<span onclick="loadByKey('${r.myKey}')">${r.myKey}</span>`;
						// 	ul.appendChild(li);
						// }
						// div.appendChild(ul);
						//
						//
						// console.log("got data", request.result);
						// const fields = ["email", "postal", "nip", "dowod", "ip", "www", "windirbig", "windir", "etcdir", "ipv6addr", "phonenb"];
						// var queried_object = JSON.parse(request.result.json);
						// for (var i of fields) {
						// 	if (i in document.forms[0]) {
						// 		document.forms[0][i].value = queried_object[i];
						// 	}
						// }
					}

					transaction.oncomplete = event => {
						console.log("All done inital load");
					};
				}

				request.onupgradeneeded = event => {
					db = event.target.result;

					var objectStore = db.createObjectStore("name", {keyPath: 'myKey'});
					// {myKey: 1, json: ""}
					objectStore.createIndex("json", "json", { unique: false});

					objectStore.transaction.oncomplete = event => {
						var nameObjectStore = db.transaction("name", 'readwrite').objectStore('name');
						const fields = ["email", "postal", "nip", "dowod", "ip", "www", "windirbig", "windir", "etcdir", "ipv6addr", "phonenb"];
						var data = {}
						for (var i of fields) {
							data[i] = '';
						}
						nameObjectStore.add({myKey: "data", json: JSON.stringify(data)});
					}

					console.log("upgradee");
				}
			}

			function reloadList() {
				var transaction = db.transaction(['name']);
					var objectStore = transaction.objectStore('name');
					var request = objectStore.getAll();
					request.onerror = event => {
						out.innerHTML = "error when getting data " + event.toString();
					}

					request.onsuccess = event => {
						console.log("Result: ");
						var div = document.getElementById("saved_users");
						div.innerHTML = "";
						var ul = document.createElement("ul");
						for (var r of request.result) {
							var li = document.createElement("li");
							li.innerHTML = `<span onclick="loadByKey('${r.myKey}')">${r.myKey}</span>`;
							ul.appendChild(li);
						}
						div.appendChild(ul);
					}
			}

			function loadByKey(e) {
				console.log(e);
				var transaction = db.transaction(['name']);
				var objectStore = transaction.objectStore('name');
				var request = objectStore.get(e);
				request.onerror = event => {
					out.innerHTML = "error when getting data " + event.toString();
				}

				request.onsuccess = event => {
					console.log("got data", request.result);
					const fields = ["email", "postal", "nip", "dowod", "ip", "www", "windirbig", "windir", "etcdir", "ipv6addr", "phonenb"];
					var queried_object = JSON.parse(request.result.json);
					for (var i of fields) {
						if (i in document.forms[0]) {
							document.forms[0][i].value = queried_object[i];
						}
					}
				}

				transaction.oncomplete = event => {
					console.log("All done");
				};
			}

			function savedata() {
				const fields = ["email", "postal", "nip", "dowod", "ip", "www", "windirbig", "windir", "etcdir", "ipv6addr", "phonenb"];
				var data = {}
				for (var i of fields) {
					data[i] = document.forms[0][i].value;
				}
				console.log("data", data);

				// Sprawdzanie czy użytkownik już istnieje w bazie.
				var objectStore = db.transaction(['name']).objectStore('name');
				var requestGet = objectStore.get(data.email);

				requestGet.onerror = event => {
					out.innerHTML = "error when getting data " + event.toString();
				}

				requestGet.onsuccess = event => {
					// Użytkownik istnieje w bazie
					if (requestGet.result) { 
						var res = requestGet.result;
						res.json = JSON.stringify(data);
						var objectStore2 = db.transaction(['name'], 'readwrite').objectStore('name');
						var requestUpdate = objectStore2.put(res);
						requestUpdate.onerror = event => {
							out.innerHTML = "error when updating data " + event.toString();
						}

						requestUpdate.onsuccess = event => {
							console.log("updated data successfully");
						}
					} else { // Dodawanie nowego użytkownika
						var transaction = db.transaction(['name'], 'readwrite');
						var objectStore1 = transaction.objectStore('name');
						var requestAdd = objectStore1.add({myKey: data.email, json: JSON.stringify(data)});
						// var requestUpdate = objectStore.put(data);

						requestAdd.onerror = event => {
							out.innerHTML = "error when updating data " + event.toString();
						}

						requestAdd.onsuccess = event => {
							console.log("updated data successfully");
							reloadList();
						}
					}
				}
			}

			var fields = document.getElementsByClassName('removable_field');
			// console.log(fields);

			var draggableelement = null;

			function dragstart(event) {
				event.dataTransfer.setData('text/plain', event.target.id);
				
				event
					.target
					.style
					.backgroundColor = 'yellow';

				draggableelement = event.target;
			}
			
			function dragover(event) {
				event.preventDefault();
				event.target.style.background = 'pink';
			}
			function dragleave(event) {
				event.preventDefault();
				event.target.style.background = 'none';
			}

			function dropp(event) {
    			event.preventDefault();
				console.log("dropped");
				let dropzone = event.target;
				event.target.style.background = 'none';
				draggableelement.style.background = 'none';
				var temp = event.target.innerHTML + "";
				document.forms[0].insertBefore(draggableelement, event.target.nextSibling);
				document.forms[0].insertBefore(event.target.nextSibling, draggableelement);
				// draggableelement.innerHTML = temp;
				draggableelement = null;
				event.dataTransfer.clearData();
			}

			for (let e of fields) {
				e.addEventListener('dragstart', dragstart);
				e.addEventListener('drop', dropp);
				e.addEventListener('dragover', dragover);
				e.addEventListener('dragleave', dragleave);
				e.setAttribute('draggable', true);
				// console.log(e.addEventListener('click', () => {console.log('test')}));
			}



			function removethis(e) {
				e.target.parentElement.remove();
			}
		</script>
	</body>
</html>